<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ RFA & RFI ‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á</title>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background-color: #f5f5f5;
      line-height: 1.6;
    }
    .container {
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, select, button {
      padding: 8px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      font-size: 14px;
      vertical-align: middle;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
      font-weight: normal;
    }
    .search, .buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .action-btn {
      font-size: 12px;
      padding: 5px 10px;
      margin: 0 2px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .action-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .action-container {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    .status-display {
      padding: 5px 10px;
      color: white;
      border-radius: 4px;
      display: inline-block;
      text-align: center;
      min-width: 100px;
      font-weight: 500;
    }
    /* Status Colors */
    .status-‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ { background-color: #228B22; } /* Forest Green */
    .status-‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å { background-color: #90EE90; color: #333; } /* Light Green */
    .status-‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° { background-color: #FFA500; color: #333; } /* Orange */
    .status-‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ { background-color: #FF4500; } /* Orange Red */
    .status-DONE { background-color: #1E90FF; } /* Dodger Blue */

    .duplicate-row { 
      background-color: #fff3f3; /* Light red background for duplicates */
      border-left: 5px solid #ffccdd; /* Red border to highlight */
    }
    .loading {
      display: none;
      text-align: center;
      padding: 15px;
      background-color: #e0f7fa;
      color: #00796b;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 14px;
      border: 1px solid #b2ebf2;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary:hover {
      background-color: #45a049;
    }
    .btn-danger {
      background-color: #f44336;
      color: white;
    }
    .btn-danger:hover {
      background-color: #da190b;
    }
    .btn-secondary {
      background-color: #2196F3;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #0b7dda;
    }
    .edit-mode {
      background-color: #f0f7ff !important;
    }
    #searchInput {
      flex-grow: 1;
      min-width: 200px;
    }
    .buttons button {
      width: auto;
      flex: 1;
      min-width: 120px;
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: #777;
      font-style: italic;
    }
    @media (max-width: 600px) {
      .action-container {
        flex-direction: column;
      }
      .action-btn {
        width: 100%;
        margin: 2px 0;
      }
    }
    /* Keyframe for fade-in/out alerts */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h2 style="color: #2E7D32;">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ RFA & RFI ‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á</h2>

    <div class="form-group">
      <label for="docName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
      <input type="text" id="docName" placeholder="‡πÄ‡∏ä‡πà‡∏ô RFA-000001" autofocus>
    </div>

    <div class="form-group">
      <label for="docStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
      <select id="docStatus">
        <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
        <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</option>
        <option value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</option>
        <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
        <option value="DONE">DONE</option>
      </select>
    </div>

    <div class="form-group">
      <label for="docDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</label>
      <input type="date" id="docDate">
    </div>

    <button class="btn-primary" onclick="addDocument()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>

    <div class="search">
      <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..." oninput="renderTable()">
    </div>

    <div class="buttons">
      <input type="file" accept=".csv" onchange="importCSV(event)" id="csvFile" style="display: none;">
      <button class="btn-secondary" onclick="document.getElementById('csvFile').click()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV</button>
      <button class="btn-secondary" onclick="downloadCSV()">üì§ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
      <button class="btn-danger" onclick="deleteSelected()">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>

    <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>

    <table>
      <thead>
        <tr>
          <th width="40"><input type="checkbox" onclick="toggleAll(this)"></th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
          <th width="150">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th width="120">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</th>
          <th width="150">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="docTable"></tbody>
    </table>
  </div>

  <script>
    // **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å**: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Apps Script Project -> Deploy -> New deployment -> Web app -> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "Execute as: Me" ‡πÅ‡∏•‡∏∞ "Who has access: Anyone" -> Copy URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
    const SCRIPT_URL = 'YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_URL_HERE'; 
    
    let documents = []; // Array to store all documents
    let allChecked = false; // For master checkbox state

    // --- Basic UI Helper Functions ---
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function updateSelectColor(select) {
      const value = select.value;
      // Remove all status classes first to ensure only one is applied
      select.classList.remove('status-‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'status-‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'status-‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°', 'status-‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'status-DONE');
      select.classList.add('status-display', `status-${value}`);
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeCsv(unsafe) {
      if (!unsafe) return '';
      // Escape double quotes by doubling them, then enclose in double quotes if it contains comma or double quote
      const str = unsafe.toString();
      if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    }

    // --- API Interaction Functions ---
    /**
     * Calls the Google Apps Script web app API.
     * @param {string} endpoint - The endpoint path (e.g., '?id=xyz' for GET/DELETE params).
     * @param {string} method - HTTP method (GET, POST, PUT, DELETE).
     * @param {object|null} data - Data payload for POST/PUT.
     * @returns {Promise<object>} JSON response from the API.
     * @throws {Error} If API call fails or returns an error status.
     */
    async function callApi(endpoint = '', method = 'GET', data = null) {
      try {
        showLoading();
        const url = `${SCRIPT_URL}${endpoint}`;
        const options = {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          }
        };
        
        if (data) {
          options.body = JSON.stringify(data);
        }
        
        // Add timestamp to prevent caching for GET requests
        const cacheBuster = url.includes('?') ? '&' : '?';
        const fullUrl = url + (method === 'GET' ? cacheBuster + '_=' + Date.now() : '');
        
        const response = await fetch(fullUrl, options);
        
        if (!response.ok) {
          // Attempt to parse error message from response body if available
          let errorText = `HTTP error! status: ${response.status}`;
          try {
            const errorJson = await response.json();
            errorText = errorJson.message || errorText;
          } catch (jsonError) {
            // Fallback to text if JSON parsing fails
            errorText = await response.text();
          }
          throw new Error(errorText);
        }
        
        const result = await response.json();
        
        if (result.status === "error") {
          throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        throw error; // Re-throw the error to be caught by the calling function
      } finally {
        hideLoading();
      }
    }

    // --- Document Management Functions ---

    /**
     * Loads documents from the API and renders the table.
     */
    async function loadDocuments() {
      try {
        documents = await callApi();
        // Mark duplicates for display purposes
        const nameCounts = {};
        documents.forEach(doc => {
          const lowerCaseName = doc.name.toLowerCase();
          nameCounts[lowerCaseName] = (nameCounts[lowerCaseName] || 0) + 1;
        });
        documents.forEach(doc => {
          doc.isDuplicate = nameCounts[doc.name.toLowerCase()] > 1;
        });
        renderTable();
      } catch (error) {
        console.error('Error loading data:', error);
        showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', error.message);
      }
    }

    /**
     * Adds a new document to the system.
     */
    async function addDocument() {
      const name = document.getElementById('docName').value.trim();
      const status = document.getElementById('docStatus').value;
      const date = document.getElementById('docDate').value;

      if (!name) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
        document.getElementById('docName').focus();
        return;
      }

      if (!date) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô');
        document.getElementById('docDate').focus();
        return;
      }

      try {
        const result = await callApi('', 'POST', { name, status, date });
        
        if (result.status === "success") {
          showAlert('success', result.message || '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          await loadDocuments(); // Reload all data to reflect changes and new IDs
          clearInputs();
          document.getElementById('docName').focus();
        }
      } catch (error) {
        console.error('Error adding document:', error);
        showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ', error.message);
      }
    }

    function clearInputs() {
      document.getElementById('docName').value = '';
      document.getElementById('docDate').value = '';
      // Reset status to default
      document.getElementById('docStatus').value = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
      updateSelectColor(document.getElementById('docStatus'));
    }

    /**
     * Deletes a document by its unique ID.
     * @param {string} id - The unique ID of the document to delete.
     * @param {number} docIndex - The original index in the `documents` array (for confirmation message).
     */
    async function deleteDocument(id, docIndex) {
      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "${documents[docIndex].name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
      
      try {
        const result = await callApi(`?id=${id}`, 'DELETE'); // Pass ID as query param for DELETE
        
        if (result.status === "success") {
          showAlert('success', result.message || '‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          await loadDocuments(); // Reload all data
        }
      } catch (error) {
        console.error('Error deleting document:', error);
        showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ', error.message);
      }
    }

    /**
     * Saves edits for a document.
     * @param {string} id - The unique ID of the document being edited.
     * @param {number} index - The original index in the `documents` array (for input IDs).
     */
    async function saveEdit(id, index) {
      const name = document.getElementById(`editName${index}`).value.trim();
      const status = document.getElementById(`editStatus${index}`).value;
      const date = document.getElementById(`editDate${index}`).value;

      if (!name) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
        document.getElementById(`editName${index}`).focus();
        return;
      }

      if (!date) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô');
        document.getElementById(`editDate${index}`).focus();
        return;
      }

      try {
        const result = await callApi('', 'PUT', { id, name, status, date });
        
        if (result.status === "success") {
          showAlert('success', result.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          await loadDocuments(); // Reload all data
        }
      } catch (error) {
        console.error('Error saving edit:', error);
        showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ', error.message);
      }
    }

    /**
     * Deletes all selected documents.
     */
    async function deleteSelected() {
      const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
      if (checkboxes.length === 0) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö');
        return;
      }

      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${checkboxes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

      try {
        showLoading();
        // Get unique IDs of selected documents
        const idsToDelete = Array.from(checkboxes).map(cb => documents[parseInt(cb.dataset.originalIndex)].id);
        
        let successCount = 0;
        let errorCount = 0;
        let errorMessages = [];

        // Delete one by one to give clear feedback for each
        for (const id of idsToDelete) {
          try {
            const result = await callApi(`?id=${id}`, 'DELETE');
            if (result.status === "success") {
              successCount++;
            } else {
              errorCount++;
              errorMessages.push(`ID: ${id} - ${result.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
            }
          } catch (error) {
            errorCount++;
            errorMessages.push(`ID: ${id} - ${error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
          }
        }
        
        await loadDocuments(); // Reload after all deletions attempts

        if (errorCount > 0) {
          showAlert('warning', 
            `‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
            errorMessages.slice(0, 5).join('<br>') + 
            (errorMessages.length > 5 ? '<br>...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ' + (errorMessages.length - 5) + ' ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : '')
          );
        } else {
          showAlert('success', `‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        }
      } catch (error) {
        console.error('Error deleting selected:', error);
        showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô', error.message);
      }
    }

    // --- Table Rendering Functions ---

    /**
     * Renders/updates the document table based on current `documents` array and search input.
     */
    function renderTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const table = document.getElementById('docTable');
      table.innerHTML = '';

      const filtered = documents
        .filter(doc =>
          doc.name.toLowerCase().includes(search) ||
          doc.status.toLowerCase().includes(search) ||
          doc.date.includes(search)
        )
        .sort((a, b) => {
          // Sort by duplicate status (duplicates first)
          if (a.isDuplicate && !b.isDuplicate) return -1;
          if (!a.isDuplicate && b.isDuplicate) return 1;
          // Then sort by date (newest first)
          return new Date(b.date) - new Date(a.date);
        });

      if (filtered.length === 0) {
        table.innerHTML = `
          <tr>
            <td colspan="5" class="no-data">
              ${documents.length === 0 ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}
            </td>
          </tr>
        `;
        // Ensure master checkbox is unchecked if no data
        document.querySelector('th input[type="checkbox"]').checked = false;
        allChecked = false;
        return;
      }

      filtered.forEach(doc => {
        const row = document.createElement('tr');
        if (doc.isDuplicate) row.classList.add('duplicate-row');

        // Store original index for checkbox to access original document object
        const originalIndex = documents.findIndex(d => d.id === doc.id);

        row.innerHTML = `
          <td><input type="checkbox" class="rowCheckbox" data-original-index="${originalIndex}" ${allChecked ? 'checked' : ''}></td>
          <td style="text-align:left;">${escapeHtml(doc.name)}</td>
          <td><span class="status-display status-${doc.status}">${escapeHtml(doc.status)}</span></td>
          <td>${escapeHtml(doc.date)}</td>
          <td>
            <div class="action-container">
              <button class="action-btn btn-secondary" onclick="editDocument(${originalIndex}, this)">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="action-btn btn-danger" onclick="deleteDocument('${doc.id}', ${originalIndex})">üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
          </td>
        `;
        table.appendChild(row);
      });
    }

    /**
     * Switches a row to edit mode.
     * @param {number} index - The original index of the document in the `documents` array.
     * @param {HTMLElement} btn - The "Edit" button element.
     */
    function editDocument(index, btn) {
      const row = btn.closest('tr');
      const doc = documents[index];

      // Remove any existing edit modes to ensure only one row is editable
      document.querySelectorAll('.edit-mode').forEach(r => r.classList.remove('edit-mode'));
      document.querySelectorAll('.action-btn.btn-primary[onclick^="saveEdit("]').forEach(b => {
          // Re-render the table to revert any unsaved edits
          renderTable(); 
      });

      row.classList.add('edit-mode');
      row.innerHTML = `
        <td></td>
        <td><input type="text" value="${escapeHtml(doc.name)}" id="editName${index}" style="width:100%;"></td>
        <td>
          <select id="editStatus${index}" onchange="updateSelectColor(this)" style="width:100%;">
            <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ${doc.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ? "selected" : ""}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ${doc.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ? "selected" : ""}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</option>
            <option value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" ${doc.status === "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" ? "selected" : ""}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</option>
            <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ${doc.status === "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ? "selected" : ""}>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            <option value="DONE" ${doc.status === "DONE" ? "selected" : ""}>DONE</option>
          </select>
        </td>
        <td><input type="date" value="${escapeHtml(doc.date)}" id="editDate${index}" style="width:100%;"></td>
        <td>
          <div class="action-container">
            <button class="action-btn btn-primary" onclick="saveEdit('${doc.id}', ${index})">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="action-btn btn-danger" onclick="renderTable()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </td>
      `;

      // Update color of the newly created select element
      setTimeout(() => {
        const editSelect = document.getElementById(`editStatus${index}`);
        if (editSelect) {
          updateSelectColor(editSelect);
        }
      }, 0);
    }

    // --- CSV Handling Functions ---

    /**
     * Downloads current document data as a CSV file.
     */
    function downloadCSV() {
      if (documents.length === 0) {
        showAlert('warning', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
      }

      const headers = ["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô"];
      // Filter out duplicates if you only want unique names in download (optional)
      // For now, it downloads all data as is from the table, but with proper escaping
      const rows = documents.map(doc => [doc.name, doc.status, doc.date]);

      let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM (Byte Order Mark) for Excel compatibility with Thai
      csvContent += headers.map(item => escapeCsv(item)).join(",") + "\n"; // Escape headers too
      rows.forEach(row => {
        csvContent += row.map(item => escapeCsv(item)).join(",") + "\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('success', '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }

    /**
     * Imports documents from a selected CSV file.
     * @param {Event} event - The file input change event.
     */
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          showLoading();
          const lines = e.target.result.split(/\r?\n/); // Handle both \n and \r\n line endings
          let successCount = 0;
          let errorCount = 0;
          let errorMessages = [];
          
          // Skip header row if it exists
          const dataLines = lines[0] && lines[0].toLowerCase().includes('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£') ? lines.slice(1) : lines;

          for (let i = 0; i < dataLines.length; i++) {
            const line = dataLines[i].trim();
            if (!line) continue; // Skip empty lines
            
            // Regex to split CSV, handles commas inside quotes and escaped quotes
            // This is a common and reasonably robust regex for simple CSV parsing
            const matches = line.match(/(?:[^,"']+|"(?:[^"]|"")*"|'(?:[^']|'')*')+/g);

            if (!matches || matches.length < 3) {
              errorCount++;
              errorMessages.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${i + 1} (‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå): ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
              continue;
            }
            
            // Trim whitespace and remove surrounding quotes
            const parsedValues = matches.map(item => item.replace(/^"|"$/g, '').replace(/^'|'$/g, '').trim());
            const [name, status, date] = parsedValues;

            // Basic validation for CSV input before sending to API
            if (!name || !status || !date) {
                errorCount++;
                errorMessages.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${i + 1} (‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå): ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ä‡∏∑‡πà‡∏≠: "${name}", ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: "${status}", ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: "${date}")`);
                continue;
            }

            // Validate date format for YYYY-MM-DD
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                errorCount++;
                errorMessages.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${i + 1} (‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå): ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${date} ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD)`);
                continue;
            }
            
            try {
              const result = await callApi('', 'POST', { name, status, date });
              if (result.status === "success") {
                successCount++;
              } else {
                errorCount++;
                errorMessages.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${i + 1} (‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå, ${name}): ${result.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
              }
            } catch (error) {
              errorCount++;
              errorMessages.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${i + 1} (‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå, ${name}): ${error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
            }
          }
          
          await loadDocuments(); // Reload all documents after import attempts
          
          if (errorCount > 0) {
            showAlert('warning', 
              `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô<br>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
              errorMessages.slice(0, 5).join('<br>') + 
              (errorMessages.length > 5 ? `<br>...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${errorMessages.length - 5} ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î` : '')
            );
          } else {
            showAlert('success', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô<br>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
          }
        } catch (error) {
          console.error('Error importing CSV:', error);
          showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', error.message);
        } finally {
          hideLoading();
          event.target.value = ''; // Clear file input
        }
      };
      reader.readAsText(file);
    }

    // --- UI Interaction Functions ---

    /**
     * Toggles all checkboxes in the table.
     * @param {HTMLInputElement} masterCheckbox - The header checkbox.
     */
    function toggleAll(masterCheckbox) {
      allChecked = masterCheckbox.checked;
      const checkboxes = document.querySelectorAll('.rowCheckbox');
      checkboxes.forEach(cb => cb.checked = allChecked);
    }

    /**
     * Displays a temporary alert message.
     * @param {string} type - 'success', 'error', 'warning', or 'info'.
     * @param {string} message - Main message to display (can include HTML).
     * @param {string} details - Optional, more detailed message (can include HTML).
     */
    function showAlert(type, message, details = '') {
      const alertDiv = document.createElement('div');
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.padding = '15px';
      alertDiv.style.borderRadius = '8px'; /* Slightly larger radius */
      alertDiv.style.color = 'white';
      alertDiv.style.zIndex = '1000';
      alertDiv.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)'; /* Stronger shadow */
      alertDiv.style.maxWidth = '450px'; /* Slightly wider */
      alertDiv.style.wordBreak = 'break-word';
      alertDiv.style.animation = 'fadeIn 0.3s forwards'; /* 'forwards' keeps the final state */
      alertDiv.style.fontFamily = 'Sarabun, sans-serif'; // Ensure Sarabun font

      if (type === 'success') {
        alertDiv.style.backgroundColor = '#4CAF50';
      } else if (type === 'error') {
        alertDiv.style.backgroundColor = '#f44336';
      } else if (type === 'warning') {
        alertDiv.style.backgroundColor = '#FFC107'; /* A bit softer yellow */
        alertDiv.style.color = '#333';
      } else { // Default to info
        alertDiv.style.backgroundColor = '#2196F3';
      }
      
      alertDiv.innerHTML = `
        <div style="font-weight:600; margin-bottom:5px;">${message}</div>
        ${details ? `<div style="font-size:12px; opacity: 0.9; margin-top:5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.3);">${details}</div>` : ''}
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.animation = 'fadeOut 0.3s forwards';
        alertDiv.addEventListener('animationend', () => {
          if (alertDiv.parentNode) { // Check if it's still in DOM
            document.body.removeChild(alertDiv);
          }
        }, { once: true }); // Ensure listener is only called once
      }, 5000); // Display for 5 seconds
    }

    // --- Event Listeners and Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize status select color
      const statusSelect = document.getElementById('docStatus');
      updateSelectColor(statusSelect);
      statusSelect.addEventListener('change', function() {
        updateSelectColor(this);
      });

      // Add Enter key listener for input fields to trigger addDocument
      document.getElementById("docName").addEventListener("keypress", function(e) {
        if (e.key === "Enter") { e.preventDefault(); addDocument(); }
      });
      document.getElementById("docDate").addEventListener("keypress", function(e) {
        if (e.key === "Enter") { e.preventDefault(); addDocument(); }
      });

      // Load documents on page load
      loadDocuments();
    });
  </script>
</body>
</html>
