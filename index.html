<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ RFA & RFI ‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á</title>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, select, button {
      padding: 8px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      font-size: 14px;
      vertical-align: middle;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
      font-weight: normal;
    }
    .search, .buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .action-btn {
      font-size: 12px;
      padding: 5px 10px;
      margin: 0 2px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .action-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .action-container {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    .status-display {
      padding: 5px 10px;
      color: white;
      border-radius: 4px;
      display: inline-block;
      text-align: center;
      min-width: 100px;
      font-weight: 500;
    }
    .status-‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ { background-color: #228B22; }
    .status-‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å { background-color: #90EE90; color: #333; }
    .status-‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° { background-color: #FFA500; color: #333; }
    .status-‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ { background-color: #FF4500; }
    .status-DONE { background-color: #1E90FF; }
    .duplicate-row { background-color: #fff3f3; }
    .loading {
      display: none;
      text-align: center;
      padding: 15px;
      background-color: #f5f5f5;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary:hover {
      background-color: #45a049;
    }
    .btn-danger {
      background-color: #f44336;
      color: white;
    }
    .btn-secondary {
      background-color: #2196F3;
      color: white;
    }
    .edit-mode {
      background-color: #f0f7ff !important;
    }
    #searchInput {
      flex-grow: 1;
      min-width: 200px;
    }
    .buttons button {
      width: auto;
      flex: 1;
      min-width: 120px;
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: #777;
      font-style: italic;
    }
    @media (max-width: 600px) {
      .action-container {
        flex-direction: column;
      }
      .action-btn {
        width: 100%;
        margin: 2px 0;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h2 style="color: #2E7D32;">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ RFA & RFI ‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á</h2>

    <div class="form-group">
      <label for="docName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
      <input type="text" id="docName" placeholder="‡πÄ‡∏ä‡πà‡∏ô RFA-000001" autofocus>
    </div>

    <div class="form-group">
      <label for="docStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
      <select id="docStatus">
        <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
        <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</option>
        <option value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</option>
        <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
        <option value="DONE">DONE</option>
      </select>
    </div>

    <div class="form-group">
      <label for="docDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</label>
      <input type="date" id="docDate">
    </div>

    <button class="btn-primary" onclick="addDocument()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>

    <div class="search">
      <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..." oninput="renderTable()">
    </div>

    <div class="buttons">
      <input type="file" accept=".csv" onchange="importCSV(event)" id="csvFile" style="display: none;">
      <button class="btn-secondary" onclick="document.getElementById('csvFile').click()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV</button>
      <button class="btn-secondary" onclick="downloadCSV()">üì§ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
      <button class="btn-danger" onclick="deleteSelected()">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>

    <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>

    <table>
      <thead>
        <tr>
          <th width="40"><input type="checkbox" onclick="toggleAll(this)"></th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
          <th width="150">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th width="120">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</th>
          <th width="150">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="docTable"></tbody>
    </table>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwt2FL4BwbrcTF8qHOzr70MtxDFLgcPyfeSOxLMh3RXPgAUypjGW9wDkrKDb8qH8mDZTQ/exec';
    let documents = [];
    let allChecked = false;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function updateSelectColor(select) {
      const value = select.value;
      select.className = '';
      select.classList.add('status-display', `status-${value}`);
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeCsv(unsafe) {
      if (!unsafe) return '';
      return unsafe.toString().replace(/"/g, '""');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö API
    async function callApi(endpoint = '', method = 'GET', data = null) {
      try {
        showLoading();
        const url = `${SCRIPT_URL}${endpoint}`;
        const options = {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          }
        };
        
        if (data) {
          options.body = JSON.stringify(data);
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ cache
        const cacheBuster = url.includes('?') ? '&' : '?';
        const fullUrl = url + cacheBuster + '_=' + Date.now();
        
        const response = await fetch(fullUrl, options);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.status === "error") {
          throw new Error(result.message);
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      } finally {
        hideLoading();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    async function loadDocuments() {
      try {
        documents = await callApi();
        renderTable();
      } catch (error) {
        console.error('Error loading data:', error);
        showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
      }
    }

    async function addDocument() {
      const name = document.getElementById('docName').value.trim();
      const status = document.getElementById('docStatus').value;
      const date = document.getElementById('docDate').value;

      if (!name) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
        document.getElementById('docName').focus();
        return;
      }

      if (!date) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô');
        document.getElementById('docDate').focus();
        return;
      }

      try {
        const result = await callApi('', 'POST', { name, status, date });
        
        if (result.status === "success") {
          showAlert('success', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          await loadDocuments();
          clearInputs();
          document.getElementById('docName').focus();
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }

    function clearInputs() {
      document.getElementById('docName').value = '';
      document.getElementById('docDate').value = '';
    }

    async function deleteDocument(id, index) {
      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "${documents[index].name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
      
      try {
        const result = await callApi(`?id=${id}`, 'DELETE');
        
        if (result.status === "success") {
          showAlert('success', '‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          await loadDocuments();
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
      }
    }

    async function saveEdit(id, index) {
      const name = document.getElementById(`editName${index}`).value.trim();
      const status = document.getElementById(`editStatus${index}`).value;
      const date = document.getElementById(`editDate${index}`).value;

      if (!name) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
        document.getElementById(`editName${index}`).focus();
        return;
      }

      if (!date) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô');
        document.getElementById(`editDate${index}`).focus();
        return;
      }

      try {
        const result = await callApi('', 'PUT', { id, name, status, date });
        
        if (result.status === "success") {
          showAlert('success', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          await loadDocuments();
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
      }
    }

    async function deleteSelected() {
      const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
      if (checkboxes.length === 0) {
        showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö');
        return;
      }

      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${checkboxes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

      try {
        showLoading();
        const ids = Array.from(checkboxes).map(cb => documents[parseInt(cb.dataset.index)].id);
        
        // ‡∏•‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ feedback ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
        let successCount = 0;
        for (const id of ids) {
          try {
            const result = await callApi(`?id=${id}`, 'DELETE');
            if (result.status === "success") successCount++;
          } catch (error) {
            console.error(`Error deleting document ${id}:`, error);
          }
        }
        
        if (successCount > 0) {
          showAlert('success', `‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å ${ids.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        } else {
          showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡πÜ ‡πÑ‡∏î‡πâ');
        }
        
        await loadDocuments();
      } catch (error) {
        console.error('Error:', error);
        showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô');
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    function renderTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const table = document.getElementById('docTable');
      table.innerHTML = '';

      const filtered = documents.map((doc, index) => ({ ...doc, index }))
        .filter(doc =>
          doc.name.toLowerCase().includes(search) ||
          doc.status.toLowerCase().includes(search) ||
          doc.date.includes(search)
        )
        .sort((a, b) => {
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
          if (a.isDuplicate && !b.isDuplicate) return -1;
          if (!a.isDuplicate && b.isDuplicate) return 1;
          // ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
          return new Date(b.date) - new Date(a.date);
        });

      if (filtered.length === 0) {
        table.innerHTML = `
          <tr>
            <td colspan="5" class="no-data">
              ${documents.length === 0 ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}
            </td>
          </tr>
        `;
        return;
      }

      filtered.forEach(doc => {
        const row = document.createElement('tr');
        if (doc.isDuplicate) row.classList.add('duplicate-row');

        row.innerHTML = `
          <td><input type="checkbox" class="rowCheckbox" data-index="${doc.index}" ${allChecked ? 'checked' : ''}></td>
          <td style="text-align:left;">${escapeHtml(doc.name)}</td>
          <td><span class="status-display status-${doc.status}">${escapeHtml(doc.status)}</span></td>
          <td>${escapeHtml(doc.date)}</td>
          <td>
            <div class="action-container">
              <button class="action-btn btn-secondary" onclick="editDocument(${doc.index}, this)">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="action-btn btn-danger" onclick="deleteDocument(${doc.id}, ${doc.index})">üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
          </td>
        `;
        table.appendChild(row);
      });
    }

    function editDocument(index, btn) {
      const row = btn.closest('tr');
      const doc = documents[index];

      row.classList.add('edit-mode');
      row.innerHTML = `
        <td></td>
        <td><input type="text" value="${escapeHtml(doc.name)}" id="editName${index}" style="width:100%;"></td>
        <td>
          <select id="editStatus${index}" onchange="updateSelectColor(this)" style="width:100%;">
            <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ${doc.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ? "selected" : ""}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ${doc.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ? "selected" : ""}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</option>
            <option value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" ${doc.status === "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" ? "selected" : ""}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</option>
            <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ${doc.status === "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ? "selected" : ""}>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            <option value="DONE" ${doc.status === "DONE" ? "selected" : ""}>DONE</option>
          </select>
        </td>
        <td><input type="date" value="${escapeHtml(doc.date)}" id="editDate${index}" style="width:100%;"></td>
        <td>
          <div class="action-container">
            <button class="action-btn btn-primary" onclick="saveEdit(${doc.id}, ${index})">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="action-btn btn-danger" onclick="renderTable()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </td>
      `;

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡∏Ç‡∏≠‡∏á select ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á DOM ‡πÅ‡∏•‡πâ‡∏ß
      setTimeout(() => {
        const editSelect = document.getElementById(`editStatus${index}`);
        updateSelectColor(editSelect);
      }, 0);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CSV
    function downloadCSV() {
      if (documents.length === 0) {
        showAlert('warning', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
      }

      const headers = ["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô"];
      const rows = documents.filter(doc => !doc.isDuplicate)
        .map(doc => [doc.name, doc.status, doc.date]);

      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += headers.join(",") + "\n";
      rows.forEach(row => {
        csvContent += row.map(item => `"${escapeCsv(item)}"`).join(",") + "\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('success', '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }

    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          showLoading();
          const lines = e.target.result.split("\n");
          let successCount = 0;
          let errorCount = 0;
          let errorMessages = [];
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || i === 0) continue; // ‡∏Ç‡πâ‡∏≤‡∏° header ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
            
            // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î
            const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
            if (matches.length < 3) continue;
            
            const [name, status, date] = matches.map(item => 
              item.replace(/^"|"$/g, '').trim()
            );
            
            try {
              const result = await callApi('', 'POST', { name, status, date });
              if (result.status === "success") {
                successCount++;
              } else {
                errorCount++;
                errorMessages.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${i+1}: ${name} - ${result.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
              }
            } catch (error) {
              errorCount++;
              errorMessages.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${i+1}: ${name} - ${error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
            }
          }
          
          await loadDocuments();
          
          if (errorCount > 0) {
            showAlert('warning', 
              `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô<br>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
              errorMessages.slice(0, 5).join('<br>') + 
              (errorMessages.length > 5 ? '<br>...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ' + (errorMessages.length - 5) + ' ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : '')
            );
          } else {
            showAlert('success', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô<br>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
          }
        } catch (error) {
          console.error('Error:', error);
          showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
        } finally {
          hideLoading();
          event.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ UI
    function toggleAll(masterCheckbox) {
      allChecked = masterCheckbox.checked;
      const checkboxes = document.querySelectorAll('.rowCheckbox');
      checkboxes.forEach(cb => cb.checked = allChecked);
    }

    function showAlert(type, message, details = '') {
      const alertDiv = document.createElement('div');
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.padding = '15px';
      alertDiv.style.borderRadius = '4px';
      alertDiv.style.color = 'white';
      alertDiv.style.zIndex = '1000';
      alertDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      alertDiv.style.maxWidth = '400px';
      alertDiv.style.wordBreak = 'break-word';
      alertDiv.style.animation = 'fadeIn 0.3s';
      
      if (type === 'success') {
        alertDiv.style.backgroundColor = '#4CAF50';
      } else if (type === 'error') {
        alertDiv.style.backgroundColor = '#f44336';
      } else if (type === 'warning') {
        alertDiv.style.backgroundColor = '#FFA500';
      } else {
        alertDiv.style.backgroundColor = '#2196F3';
      }
      
      alertDiv.innerHTML = `
        <div style="font-weight:500;margin-bottom:5px;">${message}</div>
        ${details ? `<div style="font-size:12px;margin-top:5px;">${details}</div>` : ''}
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.animation = 'fadeOut 0.3s';
        setTimeout(() => {
          document.body.removeChild(alertDiv);
        }, 300);
      }, 5000);
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡∏Ç‡∏≠‡∏á select ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
      const statusSelect = document.getElementById('docStatus');
      updateSelectColor(statusSelect);
      statusSelect.addEventListener('change', function() {
        updateSelectColor(this);
      });

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
      document.getElementById("docName").addEventListener("keypress", function(e) {
        if (e.key === "Enter") addDocument();
      });
      document.getElementById("docDate").addEventListener("keypress", function(e) {
        if (e.key === "Enter") addDocument();
      });

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      loadDocuments();
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
          from { opacity: 1; transform: translateY(0); }
          to { opacity: 0; transform: translateY(-20px); }
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>
